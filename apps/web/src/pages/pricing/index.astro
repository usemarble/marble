---
import { PRICING_PLANS } from "@marble/utils";
import Container from "@/components/Container.astro";
import AccordionItem from "@/components/ui/AccordionItem.astro";
import Button from "@/components/ui/Button.astro";
import Layout from "@/layouts/Layout.astro";
import { PRICING_FAQS } from "@/lib/constants/faqs";
import { SITE } from "@/lib/constants/site";
import { cn } from "@/lib/utils";

// Calculate yearly monthly equivalent for display
const yearlyMonthlyPrice = "$16";
---

<Layout
  title={`Pricing - ${SITE.TITLE}`}
  description="Pricing plans for marble."
>
  <div class="divide-y divide-dashed">
    <section class="border-t border-dashed">
      <div class="md:w-[calc(100%-140px)] mx-auto lg:border-x border-dashed">
        <Container class="space-y-10 lg:space-y-16 pt-12 pb-20 lg:py-24 ">
          <div class="relative flex flex-col items-center space-y-4">
            <h1
              class="relative text-center text-balance text-2xl tracking-tight md:text-3xl lg:text-4xl max-w-4xl"
            >
              Pricing
            </h1>
            <p class="max-w-prose md:text-lg text-muted-foreground text-center">
              Simple pricing, cancel anytime.
            </p>
          </div>

          <!-- Billing Toggle -->
          <div class="flex items-center justify-center gap-3">
            <span class="text-sm text-muted-foreground">Monthly</span>
            <button
              id="billing-toggle"
              type="button"
              role="switch"
              aria-checked="true"
              class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-accent transition-colors duration-200 ease-in-out focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
            >
              <span
                id="toggle-thumb"
                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-5"
              ></span>
            </button>
            <span class="text-sm text-muted-foreground">Yearly</span>
          </div>

          <ul
            class="flex flex-col items-center md:items-stretch justify-center gap-5 md:flex-row"
          >
            {PRICING_PLANS.map((plan, index) => (
                  <li class={cn("min-w-[300px] w-full max-w-[350px] rounded-xl", index === 2 && 'sm:col-span-2 lg:col-span-1 sm:h-fit')}>
                    <div class={cn("flex flex-col gap-5 rounded-[8px] bg-white w-full px-4 py-6", index === 2 ? 'sm:flex-row sm:px-14 sm:py-10 lg:py-6 sm:justify-center sm:gap-20 lg:gap-4 lg:px-4 lg:flex-col min-h-96 sm:min-h-fit lg:min-h-96' : 'min-h-96 h-full')}>
                      {index === 2 ? (
                        <>
                          <div class="flex flex-col gap-5 sm:min-w-60 lg:min-w-0">
                            <div class="flex flex-col gap-4">
                              <div class="flex items-center justify-between">
                                <h3 class="text-medium text-xl">{plan.title}</h3>
                                {plan.id === "pro" && (
                                  <span class="save-badge text-xs font-medium text-emerald-600 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded-md">
                                    Save 20%
                                  </span>
                                )}
                              </div>
                              <div>
                                <p>
                                  <span class="font-bold text-2xl" data-plan-id={plan.id} data-monthly={plan.price.monthly} data-yearly={yearlyMonthlyPrice}>
                                    {plan.id === "pro" ? yearlyMonthlyPrice : plan.price.monthly}
                                  </span>{' '}
                                  <span>per month.</span>
                                </p>

                                <p class="text-muted-foreground text-sm">{plan.description}</p>
                              </div>
                            </div>
                            <div class="border-y border-dashed py-4">
                              <Button 
                                href={plan.button.href}
                                target="_blank"
                                class="w-full"
                              >
                                {plan.button.label}
                              </Button>
                            </div>
                          </div>
                          <ul class="flex flex-col gap-2 text-sm">
                            {plan.features.map((feature) => (
                              <li class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="size-5 text-emerald-500">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span>{feature}</span>
                              </li>
                            ))}
                          </ul>
                        </>
                      ) : (
                        <>
                          <div class="flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                              <h4 class="text-medium text-2xl">{plan.title}</h4>
                              {plan.id === "pro" && (
                                <span class="save-badge text-xs font-medium text-emerald-600 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded-md">
                                  Save 20%
                                </span>
                              )}
                            </div>
                            <div>
                              <p>
                                <span class="font-bold text-2xl" data-plan-id={plan.id} data-monthly={plan.price.monthly} data-yearly={yearlyMonthlyPrice}>
                                  {plan.id === "pro" ? yearlyMonthlyPrice : plan.price.monthly}
                                </span>{' '}
                                <span>per month.</span>
                              </p>

                              <p class="text-muted-foreground text-sm">{plan.description}</p>
                            </div>
                          </div>
                          <div class="border-y border-dashed py-4">
                           <Button 
                              href={plan.button.href}
                              target="_blank"
                              class="w-full"
                              size="sm"
                            >
                              {plan.button.label}
                            </Button>
                          </div>
                          <ul class="flex flex-col gap-2 text-sm">
                            {plan.features.map((feature) => (
                              <li class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="size-5 text-emerald-500">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span>{feature}</span>
                              </li>
                            ))}
                          </ul>
                        </>
                      )}
                    </div>
                  </li>
                ))}
          </ul>
        </Container>
      </div>
    </section>

    <section>
      <div class="lg:border-x border-dashed md:w-[calc(100%-140px)] mx-auto">
        <Container class="pt-12 pb-20">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 lg:gap-20">
            <div
              class="flex flex-col items-center lg:items-start space-y-4 text-center lg:text-left"
            >
              <h2
                class="relative text-center text-balance text-2xl tracking-tight md:text-3xl lg:text-4xl lg:text-left max-w-4xl"
              >
                Frequently asked Questions
              </h2>
              <p
                class="max-w-prose md:text-lg text-muted-foreground text-balance"
              >
                Answers to common questions about pricing and billing.
              </p>
            </div>

            <div class="lg:col-span-2 divide-y divide-dashed">
              {PRICING_FAQS.map(faq => (
              <AccordionItem name="details" title={faq.question}>
                <p class="text-sm faq-answer text-muted-foreground pb-2" set:html={faq.answer} />
              </AccordionItem>
            ))}
            </div>
          </div>
        </Container>
      </div>
    </section>
  </div>
</Layout>

<script>
  function initBillingToggle() {
    const toggle = document.getElementById("billing-toggle");
    const thumb = document.getElementById("toggle-thumb");
    const saveBadges = document.querySelectorAll(".save-badge");
    const priceElements = document.querySelectorAll('[data-plan-id="pro"]');

    let isYearly = true;

    toggle?.addEventListener("click", () => {
      isYearly = !isYearly;

      // Update toggle appearance
      toggle.setAttribute("aria-checked", String(isYearly));
      if (isYearly) {
        thumb?.classList.add("translate-x-5");
        thumb?.classList.remove("translate-x-0");
        toggle.classList.add("bg-accent");
        toggle.classList.remove("bg-muted");
        for (const badge of saveBadges) {
          badge.classList.remove("hidden");
        }
      } else {
        thumb?.classList.remove("translate-x-5");
        thumb?.classList.add("translate-x-0");
        toggle.classList.remove("bg-accent");
        toggle.classList.add("bg-muted");
        for (const badge of saveBadges) {
          badge.classList.add("hidden");
        }
      }

      // Update prices
      for (const el of priceElements) {
        const monthly = el.getAttribute("data-monthly");
        const yearly = el.getAttribute("data-yearly");
        el.textContent = isYearly ? yearly : monthly;
      }
    });
  }

  // Initialize on first load
  initBillingToggle();

  // Re-initialize after page transitions
  document.addEventListener("astro:after-swap", initBillingToggle);
</script>
