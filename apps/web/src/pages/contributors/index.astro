---
export const prerender = false;

import { YOUTUBE_VIDEO_ID } from "@marble/utils";
import Container from "@/components/Container.astro";
import Button from "@/components/ui/Button.astro";
import Layout from "@/layouts/Layout.astro";
import { SITE } from "@/lib/constants/site";
import { cn } from "@/lib/utils";

const YOUTUBE_WATCH_URL = `https://www.youtube.com/watch?v=${YOUTUBE_VIDEO_ID}`;

type GitHubUser = {
  login: string;
  id: number;
  avatar_url: string;
  html_url: string;
  contributions: number;
  type: string;
};

type GitHubIssue = {
  id: number;
  number: number;
  title: string;
  html_url: string;
  state: string;
  user: {
    login: string;
    avatar_url: string;
    html_url: string;
  };
  created_at: string;
  labels: Array<{
    name: string;
    color: string;
  }>;
  pull_request?: {
    url: string;
  };
};

type GitHubPR = {
  id: number;
  number: number;
  title: string;
  html_url: string;
  state: string;
  user: {
    login: string;
    avatar_url: string;
    html_url: string;
  };
  created_at: string;
  draft: boolean;
};

type GitHubRepo = {
  name: string;
  full_name: string;
  html_url: string;
  stargazers_count: number;
  forks_count: number;
  open_issues_count: number;
  language: string;
  description: string;
  private: boolean;
};

async function fetchGitHubData() {
  const baseUrl = "https://api.github.com";
  const org = "usemarble";
  const headers: Record<string, string> = {
    Accept: "application/vnd.github+json",
  };

  try {
    const [repoResponse, contributorsResponse, issuesResponse, prsResponse] =
      await Promise.all([
        fetch(`${baseUrl}/repos/${org}/marble`, { headers }),
        fetch(`${baseUrl}/repos/${org}/marble/contributors?per_page=100`, {
          headers,
        }),
        fetch(
          `${baseUrl}/repos/${org}/marble/issues?state=open&per_page=20&sort=created`,
          { headers }
        ),
        fetch(
          `${baseUrl}/repos/${org}/marble/pulls?state=open&per_page=5&sort=created`,
          { headers }
        ),
      ]);

    const repo: GitHubRepo | null = repoResponse.ok
      ? await repoResponse.json()
      : null;
    const contributors: GitHubUser[] = contributorsResponse.ok
      ? (await contributorsResponse.json()).filter(
          (c: GitHubUser) => c.login !== "turbobot-temp"
        )
      : [];
    const allIssues: GitHubIssue[] = issuesResponse.ok
      ? await issuesResponse.json()
      : [];
    const issues: GitHubIssue[] = allIssues
      .filter((issue) => !issue.pull_request)
      .slice(0, 5);
    const prs: GitHubPR[] = prsResponse.ok
      ? (await prsResponse.json()).slice(0, 5)
      : [];

    const totalStars = repo?.stargazers_count || 0;
    const totalForks = repo?.forks_count || 0;
    const totalIssues = repo?.open_issues_count || 0;

    return {
      repo,
      contributors: contributors.filter((c) => c.type === "User").slice(0, 24),
      issues,
      prs,
      stats: {
        totalStars,
        totalForks,
        totalIssues,
        totalContributors: contributors.filter((c) => c.type === "User").length,
      },
    };
  } catch (error) {
    console.error("Error fetching GitHub data:", error);
    return {
      repo: null,
      contributors: [],
      issues: [],
      prs: [],
      stats: {
        totalStars: 0,
        totalForks: 0,
        totalIssues: 0,
        totalContributors: 0,
      },
    };
  }
}

const githubData = await fetchGitHubData();

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

function getIssueTypeFromLabels(
  labels: Array<{ name: string; color: string }>
) {
  const bugLabel = labels.find((label) =>
    label.name.toLowerCase().includes("bug")
  );
  const featureLabel = labels.find(
    (label) =>
      label.name.toLowerCase().includes("feature") ||
      label.name.toLowerCase().includes("enhancement")
  );
  const docLabel = labels.find((label) =>
    label.name.toLowerCase().includes("doc")
  );

  if (bugLabel) {
    return { type: "Bug", color: "bg-red-100 text-red-800" };
  }
  if (featureLabel) {
    return { type: "Feature", color: "bg-blue-100 text-blue-800" };
  }
  if (docLabel) {
    return { type: "Docs", color: "bg-green-100 text-green-800" };
  }
  return { type: "Issue", color: "bg-yellow-100 text-yellow-800" };
}

Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=3600, stale-while-revalidate=60"
);
---
<Layout
  title={`Contributors & Community - ${SITE.TITLE}`}
  description="Meet the amazing developers and contributors who help build Marble. Explore our open source projects, contribute to issues, and join our growing community."
>
  <div class="divide-y divide-dashed">
    <section class="border-t border-dashed">
      <div class="lg:border-x border-dashed md:w-[calc(100%-140px)] mx-auto">
        <Container class="space-y-12 lg:space-y-20 pt-12 pb-20 lg:py-24">
          <div
            class="relative flex flex-col items-center space-y-4 text-center"
          >
            <h1
              class="relative text-2xl tracking-tight md:text-3xl lg:text-4xl max-w-[25ch] mx-auto"
            >
              Contributors & Community
            </h1>
            <p class="mx-auto max-w-[60ch] md:text-lg text-muted-foreground">
              Meet the amazing developers and contributors who help build
              Marble.
            </p>
          </div>

          <div class="grid gap-6 grid-cols-2 md:grid-cols-4 text-center">
            <div class="space-y-2">
              <div class="text-3xl md:text-4xl font-bold text-primary">
                {githubData.stats.totalContributors}
              </div>
              <div class="text-sm text-muted-foreground">Contributors</div>
            </div>
            <div class="space-y-2">
              <div class="text-3xl md:text-4xl font-bold text-primary">
                {githubData.stats.totalStars}
              </div>
              <div class="text-sm text-muted-foreground">Stars</div>
            </div>
            <div class="space-y-2">
              <div class="text-3xl md:text-4xl font-bold text-primary">
                {githubData.stats.totalForks}
              </div>
              <div class="text-sm text-muted-foreground">Forks</div>
            </div>
            <div class="space-y-2">
              <div class="text-3xl md:text-4xl font-bold text-primary">
                {githubData.stats.totalIssues}
              </div>
              <div class="text-sm text-muted-foreground">Open Issues</div>
            </div>
          </div>

          <div class="space-y-8">
            <div class="text-center">
              <h2 class="text-2xl md:text-3xl mb-4">
                Our Contributors<span class="text-accent">.</span>
              </h2>
              <p class="text-muted-foreground max-w-[50ch] mx-auto">
                Thank you to all the amazing people who have contributed to
                Marble!
              </p>
            </div>

            <div
              class="grid gap-4 grid-cols-3 md:grid-cols-6 lg:grid-cols-8 max-w-4xl mx-auto"
            >
              {githubData.contributors.map((contributor) => (
                <a
                  href={contributor.html_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="group flex flex-col items-center space-y-2 p-3 rounded-lg hover:bg-gray-50 transition-colors"
                  title={`${contributor.login} - ${contributor.contributions} contributions`}
                >
                  <img
                    src={contributor.avatar_url}
                    alt={`Avatar of ${contributor.login}`}
                    class="w-12 h-12 rounded-full group-hover:scale-110 transition-transform duration-200"
                    loading="lazy"
                  />
                  <span class="text-xs text-center text-muted-foreground group-hover:text-foreground transition-colors truncate w-full">
                    {contributor.login}
                  </span>
                </a>
              ))}
            </div>
          </div>

          <div class="grid gap-8 lg:gap-12 grid-cols-1 lg:grid-cols-2">
            <div class="space-y-6">
              <div class="flex items-center justify-between">
                <h2 class="text-xl md:text-2xl">Open Issues</h2>
                <a
                  href="https://github.com/usemarble/marble/issues"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm font-medium text-accent flex items-center gap-1 group"
                >
                  View all
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 transition-transform group-hover:translate-x-1">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                  </svg>
                </a>
              </div>

              <div class="space-y-3">
                {githubData.issues.length === 0 ? (
                  <div class="text-center py-8 text-muted-foreground">
                    No open issues at the moment
                  </div>
                ) : (
                  githubData.issues.map((issue) => {
                    const issueType = getIssueTypeFromLabels(issue.labels);
                    return (
                      <div class="bg-white rounded-xl p-4 border border-dashed hover:shadow-sm transition-all duration-300">
                        <div class="flex items-start gap-3">
                          <img
                            src={issue.user.avatar_url}
                            alt={`Avatar of ${issue.user.login}`}
                            class="w-6 h-6 rounded-full flex-shrink-0 mt-0.5"
                            loading="lazy"
                          />
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                              <span class={cn("inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium", issueType.color)}>
                                {issueType.type}
                              </span>
                              <span class="text-xs text-muted-foreground">
                                #{issue.number}
                              </span>
                            </div>
                            <a
                              href={issue.html_url}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="font-medium text-sm hover:text-primary transition-colors line-clamp-2"
                            >
                              {issue.title}
                            </a>
                            <p class="text-xs text-muted-foreground mt-1">
                              by {issue.user.login} • {formatDate(issue.created_at)}
                            </p>
                          </div>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>

            <div class="space-y-6">
              <div class="flex items-center justify-between">
                <h2 class="text-xl md:text-2xl">Open Pull Requests</h2>
                <a
                  href="https://github.com/usemarble/marble/pulls"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm font-medium text-accent flex items-center gap-1 group"
                >
                  View all
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 transition-transform group-hover:translate-x-1">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                  </svg>
                </a>
              </div>

              <div class="space-y-3">
                {githubData.prs.length === 0 ? (
                  <div class="text-center py-8 text-muted-foreground">
                    No open pull requests at the moment
                  </div>
                ) : (
                  githubData.prs.map((pr) => (
                    <div class="bg-white rounded-xl p-4 border border-dashed hover:shadow-sm transition-all duration-300">
                      <div class="flex items-start gap-3">
                        <img
                          src={pr.user.avatar_url}
                          alt={`Avatar of ${pr.user.login}`}
                          class="w-6 h-6 rounded-full flex-shrink-0 mt-0.5"
                          loading="lazy"
                        />
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-2">
                            <span class={cn("inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium", pr.draft ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800')}>
                              {pr.draft ? 'Draft' : 'Ready'}
                            </span>
                            <span class="text-xs text-muted-foreground">
                              #{pr.number}
                            </span>
                          </div>
                          <a
                            href={pr.html_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="font-medium text-sm hover:text-primary transition-colors line-clamp-2"
                          >
                            {pr.title}
                          </a>
                          <p class="text-xs text-muted-foreground mt-1">
                            by {pr.user.login} • {formatDate(pr.created_at)}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </Container>
      </div>
    </section>

    <!-- CTA -->
    <section class="border-b border-dashed">
      <div class="lg:border-x border-dashed md:w-[calc(100%-140px)] mx-auto">
        <Container class="py-12 md:py-20">
          <div class="flex flex-col items-center space-y-6">
            <div class="space-y-4 text-center">
              <h2
                class="relative text-center text-balance text-2xl tracking-tight md:text-3xl lg:text-4xl max-w-4xl"
              >
                Get started today.
              </h2>
              <p class="mx-auto max-w-2xl text-muted-foreground md:text-lg text-balance">
                Create and manage content, so you can focus on what matters most.
              </p>
            </div>
            
            <div class="flex flex-col sm:flex-row w-full items-center justify-center gap-4">
              <Button
                href={SITE.APP_URL}
                target="_blank"
                class="w-full sm:w-auto"
              >
                Try Marble for free
              </Button>
              <Button
                href={YOUTUBE_WATCH_URL}
                variant="secondary"
                class="w-full sm:w-auto"
              >
                Watch Demo
              </Button>
            </div>
          </div>
        </Container>
      </div>
    </section>
  </div>
</Layout>
